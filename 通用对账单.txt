select  t.发票号,
          t.ID,
          t.fnumber,
          t.到厂时间,
          t.委托单号,
          t.业务描述,
          t.任务单号,
          t.运输作业单号,
          t.装箱单号,
          t.订舱号,
          t.运输路线,
          t.起运地,
          t.目的地,
          t.路线,
          t.工厂,
          t.截关日期,
          t.柜型,
          t.柜号,
          t.运输作业单位,

t.币种,

          t.报关作业单位,
          t.封条号,
          t.车牌号,
          t.客户下单人,
          t.客户简称,
          t.FAX,
          t.Tel,
          t.对账公司,
          t.对账地址,
          t.对账电话,
          t.对账传真,
          t.对账银行,
t.对账公司2,
t.对账地址2,
t.对账电话2,
t.对账传真2,
t.对账账号2,
          t.费用项目,
         SUM( t.金额) 金额,
         MAX(isnull( t.备注,'')) 备注,
          t.费用属性,
          t.船编码,
          t.进出口类型,
          t.来回,
          t.司机名称,
          t.司机手机,
	  t.特殊标识,
          null 网点代码,
          t.收款类型 from (
select BSCB.CFriderCarMember 发票号,
       BSCB.fid as ID, BSCB.fnumber,
       BSCB.CFFactoryTime  到厂时间,
       BSCB.fnumber 委托单号,
CASE  BSCB.CFBUSINESSDEC WHEN 1 THEN '纯运输' WHEN 2 THEN '纯报关' WHEN 3 THEN '运输与报关' END 业务描述 ,
       TMSTPM.FNUMBER 任务单号,
      -- CMSCUSTK.FNUMBER 报关任务单号,
       TMSWBMM.FNUMBER 运输作业单号,
      -- CMSCUSJ.fnumber 报关作业单号,
       BSCB.CFInlandBOL 装箱单号,
       BSCB.CFBOOKINGNUMBER 订舱号,
              case
       when CHARINDEX('中创二堆场',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'中创二堆场' ,'四期/五期')
       when CHARINDEX('大亚二堆场',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'大亚二堆场' ,'四期/五期')
       when CHARINDEX('招商国际',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'招商国际' ,'四期/五期')
       when CHARINDEX('东华永港',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'东华永港' ,'四期/五期')
       when CHARINDEX('永港',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'永港' ,'四期/五期')
       when CHARINDEX('鑫三利二',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'鑫三利二' ,'四期/五期')
       when CHARINDEX('和欣',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'和欣' ,'四期/五期')
       when CHARINDEX('中集2',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'中集2' ,'四期/五期')
       when CHARINDEX('中集5',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'中集5' ,'四期/五期')
       when CHARINDEX('地中海',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'地中海' ,'四期/五期')
       when CHARINDEX('润信',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'润信' ,'四期/五期')
       when CHARINDEX('远信',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'远信' ,'四期/五期')
       when CHARINDEX('东华二',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'东华二' ,'四期/五期')
       when CHARINDEX('长胜中创',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'长胜中创' ,'四期/五期')
       when CHARINDEX('通达三',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'通达三' ,'四期/五期')
       when CHARINDEX('港吉',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'港吉' ,'四期/五期')
       when CHARINDEX('远东',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'远东' ,'四期/五期')
       when CHARINDEX('中集3',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'中集3' ,'四期/五期')
       when CHARINDEX('勃远',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'勃远' ,'四期/五期')
       when CHARINDEX('穿山',TMSWBMM.CFLinkDesc) <>0 then REPLACE(TMSWBMM.CFLinkDesc,'穿山' ,'四期/五期')
      else TMSWBMM.CFLinkDesc end 运输路线,
       TMSWBMM.CFLinkDesc 路线,
       QADDRESS.FSimpleName 起运地,
       QADDRESS2.FSimpleName 目的地,
       TMSWBMM.CFFactory 工厂,
       TMSTPM.CFHeavyTankTime 截关日期,
       BSCB.CFSizeModel 柜型,
       BSCB.CFTankNumber 柜号,
       ADM2.FNAME_L2 运输作业单位,
       ADM3.FNAME_L2 报关作业单位,




       BSCB.CFSealNumber 封条号,
       VMSVMM.CFVehLicensePlate 车牌号,
       CRMCMT.CFContactName 客户下单人,
CRMCUS.cfshortname 客户简称,
CRMCUS.CFFax FAX,
CRMCUS.CFTel Tel,
CRMCUS.CFAccountCompany 对账公司,
CRMCUS.CFAccountAddress 对账地址,
CRMCUS.CFAccountCell 对账电话,
CRMCUS.CFAccountFax 对账传真,
CRMCUS.CFAccountBank  对账银行,
Company.CFRecName 对账公司2,
Company.CFRecAddress 对账地址2,
Company.CFRecTel 对账电话2,
Company.CFRecFax 对账传真2,
Company.CFRecNumber 对账账号2,
BDMFI.CFCHNAME 费用项目,
BMSFMENT.CFAmount 金额,
BMSFMENT.CFMEMO 备注,
BMSFMENT.CFFEEATTR  费用属性,
SHIPCOM.FNumber  船编码,
BMSFM.CFImpexp 进出口类型,
BDMCAG.fname_l2 收款类型,
CASE TMSTPM.CFBackForth WHEN 0 THEN '单程' WHEN 2 THEN '往返' end 来回,
VMSDriver.CFDriverName 司机名称,
VMSDriver.CFMobilePhone 司机手机,
BDMSM.FName_l2 特殊标识,
	CU.FNAME_L2  币种,
null 
 from T_ISCM_BSCBusinessEntrusted BSCB
 left join T_ISCM_BMSFeeManage BMSFM on BSCB.fnumber =  BMSFM.cfentrustnumber  --费用主表
 LEFT JOIN T_ISCM_BMSFeeManageEntry BMSFMENT ON BMSFMENT.FPARENTID = BMSFM.FID --费用明细  
 LEFT JOIN T_ISCM_BDMFeeItem BDMFI ON BMSFMENT.CFFeeItemID = BDMFI.FID --费用项目管理
 LEFT JOIN T_ISCM_BDMDataDictionary BDMCAG ON BMSFMENT.CFComeAndGoID = BDMCAG.FID --往来
 LEFT JOIN T_ISCM_CRMCustomerfile FECRMCUS ON BMSFMENT.CFPayUnitNumber = FECRMCUS.FID --客户 
 left JOIN T_ORG_Admin ADM on BMSFM.CFOpeUnitID = ADM.FID --操作部门  
 LEFT JOIN T_ISCM_TMSTransPortManage TMSTPM on TMSTPM.CFBeNumberID = BSCB.fid --运输任务
 LEFT JOIN T_ISCM_CRMContactMgmt CRMCMT ON BSCB.CFCorderContactID = CRMCMT.FID --客户联系人
 LEFT JOIN T_ISCM_TMSAirWayBillManageMent TMSWBMM ON TMSWBMM.CFTransTaskID = TMSTPM.FID --运输作业
 LEFT JOIN T_ISCM_BDMTransportAddress QADDRESS ON QADDRESS.fid=TMSWBMM.CFStartAddressID--起运地
 LEFT JOIN T_ISCM_BDMTransportAddress QADDRESS2 ON QADDRESS2.fid=TMSWBMM.CFEndAddressID--目的地
  LEFT JOIN T_ORG_Admin ADM2 on TMSWBMM.CFOperateDepID = ADM2.FID --操作部门
 LEFT JOIN T_ISCM_BDMShipCom SHIPCOM ON SHIPCOM.fid=TMSWBMM.CFShipCompanyID--船公司
 LEFT JOIN T_ISCM_VMSVehManageMent VMSVMM ON TMSWBMM.CFVehManageID = VMSVMM.FID --车辆档案管理
 LEFT JOIN T_ISCM_BDMDataDictionary BDMSM ON BSCB.CFSpecialMarkID = BDMSM.FID --特殊标识
LEFT JOIN T_ISCM_CMSCustomsTask CMSCUSTK ON CMSCUSTK.CFEntrustedID = BSCB.FID --报关任务
LEFT join T_ORG_Admin ADM3 ON CMSCUSTK.CFOperateDeptID=ADM3.FID
--LEFT  JOIN T_ISCM_CMSCustomsJobs CMSCUSJ ON CMSCUSJ.CFTaskID = CMSCUSTK.FID --报关作业
  LEFT JOIN T_ISCM_CRMCustomerfile CRMCUS ON BSCB.CFCustomerID = CRMCUS.FID --客户 
  LEFT JOIN T_ISCM_BDMRecCompany Company ON Company.CFCompanyID=CRMCUS.CFClearingCpnNameI--对账公司
 LEFT JOIN T_ISCM_VMSDriverManager VMSDriver ON  VMSDriver.FID=TMSWBMM.CFMainDriverID --司机档案
 left join T_BD_Currency CU on  BMSFMENT.CFCurrencyID = CU.fid
 where FECRMCUS.FID = '@payVal' and BMSFMENT.CFPayUnitNumber='@payFac' and BMSFM.CFClosed = '@isbusiness' and ADM2.FNUMBER IN ('@operate')  
 and BSCB.CFBillStatus < 6
and  CU.FName_l2 =  '@bz'
 and
 BSCB.CFBusinessDec = '@businessDec' AND -- 业务描述
 BSCB.CFFactoryTime >= {ts'@reqStartTime'} AND
 BSCB.CFFactoryTime <= {ts'@reqEndTime'} AND
 CRMCUS.FID = '@customer' and
 BDMSM.fid = '@SpecialMark' AND
 fee.ATTR = '@ys' and BSCB.CFTankNumber='@gh'
 and BSCB.CFInlandBOL='@zxdh' and BSCB.CFBOOKINGNUMBER='@dch'
) t 
group by 
 t.发票号,
          t.ID,
          t.fnumber,
          t.到厂时间,
          t.委托单号,
          t.业务描述,
          t.任务单号,
          t.运输作业单号,
          t.装箱单号,
          t.订舱号,
          t.运输路线,
          t.路线,
          t.起运地,
          t.工厂,
          t.截关日期,
          t.柜型,
          t.柜号,
          t.运输作业单位,
          t.报关作业单位,




          t.封条号,
          t.车牌号,
          t.客户下单人,
          t.客户简称,
          t.FAX,
          t.Tel,
          t.对账公司,
          t.对账地址,
          t.对账电话,
          t.对账传真,
          t.对账银行,
t.对账公司2,
t.对账地址2,
t.对账电话2,
t.对账传真2,
t.对账账号2,
          t.费用项目,
        t.币种,
          t.费用属性,
          t.船编码,
          t.进出口类型,
          t.收款类型,
          t.来回,
          t.司机名称,
          t.司机手机,
	  t.特殊标识,
          null,
          t.目的地
 order by  t.到厂时间,t.运输作业单号,t.装箱单号,t.柜号,t.任务单号